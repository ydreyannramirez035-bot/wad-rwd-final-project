<?php
function get_db(): SQLite3
{
    static $db = null;
    if ($db !== null) {
        return $db;
    }
    $dbPath = __DIR__ . '/../users.db';
    $db = new SQLite3($dbPath);
    $db->enableExceptions(true);

    // CRITICAL: Enable Foreign Key enforcement in SQLite
    $db->exec('PRAGMA foreign_keys = ON;');

    //PARENT TABLE 1: Roles
    $db->exec('CREATE TABLE IF NOT EXISTS roles (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        description TEXT
        )');

    // I want to dynamic to inserting the name, and description` for the role
    $db->exec("
    INSERT OR IGNORE INTO roles (name, description) VALUES
    ('admin', 'Full access to the system, can manage users and settings'),
    ('student', 'Regular user with standard access');
    ");
    
    // PARENT TABLE 2: Courses 
    $db->exec('CREATE TABLE IF NOT EXISTS courses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        course_name TEXT NOT NULL UNIQUE
    )');

    $db->exec("
        INSERT OR IGNORE INTO courses (course_name) VALUES
        ('Bachelor of Science in Information System'),
        ('Asscociate in Computer Technology')
    ");

    // PARENT TABLE 3: Users (Centralized Login)
    $db->exec('CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        role_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        email TEXT NOT NULL UNIQUE,
        password_hash TEXT NOT NULL,
        FOREIGN KEY (role_id) REFERENCES roles(id)
    )');

    // INFO TABLE: Admins (Child of Users)
    $db->exec('CREATE TABLE IF NOT EXISTS admins (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL UNIQUE,
        name TEXT NOT NULL, 
        position TEXT,
        FOREIGN KEY (user_id) REFERENCES users(id)
    )');

    // INFO TABLE: Teachers 
    $db->exec('CREATE TABLE IF NOT EXISTS teachers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE
    )');

    // INFO TABLE: Students (Child of Users)
    $db->exec('CREATE TABLE IF NOT EXISTS students (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER UNIQUE,
        student_number TEXT(50) NOT NULL UNIQUE,
        last_name TEXT(50) NOT NULL,
        first_name TEXT(50),
	    middle_name TEXT(50),
        age INTEGER,
        course_id INTEGER NOT NULL,
        year_level INTEGER,
        email TEXT(255) UNIQUE,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (course_id) REFERENCES courses(id)
    )');


    // INDEPENDENT TABLE: Schedules 
    $db->exec('CREATE TABLE IF NOT EXISTS schedules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        day TEXT NOT NULL,
        subject TEXT NOT NULL,
        teacher_id INTEGER NOT NULL, 
        room TEXT(10),
        time_start TIME,
        time_end TIME,
        FOREIGN KEY (teacher_id) REFERENCES teachers(id)
    );');

    // JUNCTION TABLE: StudentSchedules (Many-to-Many Enrollment)
    $db->exec('CREATE TABLE IF NOT EXISTS studentSchedules (
        user_id INTEGER NOT NULL,
        schedule_id INTEGER NOT NULL,
        PRIMARY KEY (user_id, schedule_id),
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (schedule_id) REFERENCES schedules(id)
    );');

    return $db;
}